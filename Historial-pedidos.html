<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Historial de Pedidos - Libre & Rico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> 
    
    <style>
        /* Estilos base (m√°s limpios para la vista de usuario) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa; /* Fondo m√°s claro */
            padding: 20px;
        }
        .container-user {
            max-width: 800px; /* Centrar y limitar ancho */
            margin: auto;
        }
        h2 {
            color: #198754;
            border-bottom: 2px solid #198754;
            padding-bottom: 15px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 400; 
        }

        /* Estilo de la Tarjeta de Pedido Individual */
        .pedido-card {
            border: 1px solid #dee2e6;
            border-left: 5px solid #198754; /* Borde de color principal */
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ced4da;
        }
        .pedido-id {
            font-weight: bold;
            color: #198754;
            font-size: 1.1rem;
        }
        .pedido-date, .pedido-total {
            font-size: 0.95rem;
            color: #6c757d;
        }
        .item-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: 15px;
        }
        .item-list li {
            padding: 5px 0;
            border-bottom: 1px dotted #e9ecef;
            font-size: 0.9rem;
            color: #495057;
        }
        .item-list li:last-child {
            border-bottom: none;
        }

        /* Badge de Estado Espec√≠fico */
        .badge-estado {
            padding: 6px 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* Estilos de Nav (manteniendo los originales) */
       .nav-link i {
            transition: all 0.3s ease; 
        }

        .nav-link i:hover {
            color:#28a745;
            transform: scale(1.3); 
            cursor: pointer;
        }
        
        .nav-link:hover {
            color: #28a745;
            cursor: pointer;
        }
        
        /* --- ESTILOS DEL SISTEMA DE ESTRELLAS --- */
        .rating {
            font-size: 1.5rem; /* Tama√±o de las estrellas */
            cursor: pointer;
        }
        .rating i {
            color: #ccc; /* Color por defecto (gris) */
            transition: color 0.2s;
        }
        .rating i.active,
        .rating:hover i {
            color: #ffc107; /* Color dorado para seleccionadas o hover */
        }
        /* Para el hover: selecciona todas las estrellas ANTERIORES */
        .rating i:hover ~ i {
            color: #ccc; 
        }
        /* Para que al hacer hover en una, las previas se iluminen */
        .rating i:hover,
        .rating i.active {
            color: #ffc107;
        }
        
        /* Nuevo estilo para el bot√≥n de factura */
        .btn-invoice {
            color: #198754; /* Texto oscuro */
            border-color: #ced4da; /* Borde gris claro */
            background-color: #f8f9fa; /* Fondo muy claro */
            transition: background-color 0.2s, border-color 0.2s;
            margin-right: 8px; /* Espacio con el bot√≥n de Reordenar */
        }
        .btn-invoice:hover:not(:disabled) {
            background-color: #e9ecef; /* Fondo ligeramente m√°s oscuro al pasar el rat√≥n */
            border-color: #198754;
            color: #198754;
        }
        .btn-invoice:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Estilos para el timeline de seguimiento */
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 30px;
        }
        
        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 30px;
            width: 2px;
            height: calc(100% - 10px);
            background-color: #dee2e6;
        }
        
        .timeline-item.completed:not(:last-child)::before {
            background-color: #198754;
        }
        
        .timeline-marker {
            position: absolute;
            left: -32px;
            top: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .timeline-item.completed .timeline-marker {
            background-color: #198754;
        }
        
        .timeline-item.active .timeline-marker {
            background-color: #ffc107;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
            }
        }
        
        .timeline-content {
            margin-left: 10px;
        }
        
        /* Estilos para el contenedor del mapa */
        .map-container {
            position: relative;
        }
        
        .map-container iframe {
            border-radius: 8px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold fs-3 text-success"  href="Index.html">LIBRE & RICO</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="Index.html">Inicio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="Productos.html">Productos</a>
                </li>
                <li class="nav-item" id="nav-inicio-sesion">
                    <a class="nav-link" href="Inicio_Sesion.html">Inicio Sesi√≥n</a>
                </li>
                <li class="nav-item" id="nav-registro">
                    <a class="nav-link" href="Registro.html">Registrate</a>
                </li>
                <li class="nav-item" id="nav-portal-empleados" style="display: none;">
                    <a class="nav-link" href="Portal_de_empleados.html">Portal de empleados</a>
                </li>
                <li class="nav-item" id="nav-historial-pedidos" style="display: none;">
                    <a class="nav-link active text-success" href="Historial-pedidos.html">Historial de pedidos</a>
                </li>
                <li class="nav-item" id="nav-analisis-ventas" style="display: none;">
                    <a class="nav-link" href="Historial_pedidos.html">An√°lisis de Ventas</a>
                </li>
                <li class="nav-item" id="nav-administrar-productos" style="display: none;">
                    <a class="nav-link" href="Administrar_productos.html">Administrar Productos</a>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link text-success" href="#" id="cartDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-shopping-cart fa-lg position-relative"></i>
                        <span class="cart-notification-dot" id="cart-notification-badge"></span>
                    </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="cartDropdown" id="cart-items-container" style="min-width: 300px;">
                    <li class="dropdown-header text-center">üõí Carrito de Compras</li>
                    <div id="cart-products">
                        <li class="dropdown-item text-muted text-center" id="empty-cart-message">El carrito est√° vac√≠o.</li>
                    </div>
        
                    <li><hr class="dropdown-divider"></li>
        
                    <li class="d-flex justify-content-between p-2 fw-bold bg-light">
                        <span class = "text-success">Total:</span>
                        <span id="cart-total" class = "text-success">$0.00</span>
                    </li>
                    <li class="p-2">
                        <a href="Carrito.html" class="btn btn-success w-100">Finalizar Compra</a>
                    </li>
                </ul>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link text-success" href="Perfil.html"><i class="fas fa-user-circle fa-lg"></i></a>
                </li>
                <li class = "nav-item">
                    <a class="nav-link text-success" href="favoritos.html"><i class= "fa-solid fa-heart fa-lg"></i></a> 
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-user">
    <h2 class="text-success"><i class="bi bi-bag-check-fill"></i> Mi Historial de Pedidos</h2>

    <!-- Contenedor din√°mico para los pedidos -->
    <div id="pedidos-container">
        <div class="text-center py-5">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="text-muted mt-3">Cargando tus pedidos...</p>
        </div>
    </div>

    <p class="text-center text-muted mt-4" id="mensaje-soporte" style="display: none;">¬øTienes un problema con un pedido? Cont√°ctanos.</p>

</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ========================================
// VERIFICACI√ìN DE SESI√ìN
// ========================================

function verificarSesion() {
    let usuarioEmail = localStorage.getItem("usuarioEmail");
    
    if (!usuarioEmail) {
        const usuarioLocal = localStorage.getItem("usuario");
        if (usuarioLocal) {
            try {
                const usuarioObj = JSON.parse(usuarioLocal);
                if (usuarioObj && typeof usuarioObj === 'object' && usuarioObj.correo) {
                    usuarioEmail = usuarioObj.correo;
                    localStorage.setItem("usuarioEmail", usuarioEmail);
                }
            } catch (e) {
                if (usuarioLocal.includes("@")) {
                    usuarioEmail = usuarioLocal;
                    localStorage.setItem("usuarioEmail", usuarioEmail);
                }
            }
        }
    }
    
    if (!usuarioEmail) {
        alert("Debes iniciar sesi√≥n para acceder a esta p√°gina");
        window.location.href = "Inicio_Sesion.html";
        return false;
    }
    
    // Esta p√°gina es visible para cualquier usuario con sesi√≥n iniciada
    
    return true;
}

    // --- Funci√≥n para mostrar/ocultar enlaces del navbar seg√∫n sesi√≥n ---
    function actualizarEnlacesNavbar() {
        const usuarioEmail = obtenerUsuarioEmail();
        
        // Detectar super usuario
        let esSuperUser = false;
        const uLocal = localStorage.getItem("usuario");
        if (uLocal) {
            try { const uObj = JSON.parse(uLocal); if (uObj && uObj.es_super_usuario === true) esSuperUser = true; } catch(e) {}
        }
        if (!esSuperUser && usuarioEmail) {
            const SUPER_USUARIOS = ["rafaarodriguezjr@gmail.com", "alguien@example.com"];
            esSuperUser = SUPER_USUARIOS.some(e => e.toLowerCase() === usuarioEmail.toLowerCase());
        }

        // Portal de empleados: visible solo super usuario
        const portalEmpleados = document.getElementById("nav-portal-empleados");
        if (portalEmpleados) portalEmpleados.style.display = esSuperUser ? "" : "none";

        // Historial de pedidos: visible si hay sesi√≥n (o super)
        const historialPedidos = document.getElementById("nav-historial-pedidos");
        if (historialPedidos) historialPedidos.style.display = (usuarioEmail || esSuperUser) ? "" : "none";

        // An√°lisis de ventas: solo super usuario
        const analisisVentas = document.getElementById("nav-analisis-ventas");
        if (analisisVentas) analisisVentas.style.display = esSuperUser ? "" : "none";

        // Administrar productos: solo super usuario
        const adminProductos = document.getElementById("nav-administrar-productos");
        if (adminProductos) adminProductos.style.display = esSuperUser ? "" : "none";

        // Ocultar enlaces de registro e inicio sesi√≥n si hay sesi√≥n iniciada
        const inicioSesion = document.getElementById("nav-inicio-sesion");
        const registro = document.getElementById("nav-registro");
        if (usuarioEmail) {
            if (inicioSesion) inicioSesion.style.display = "none";
            if (registro) registro.style.display = "none";
        } else {
            if (inicioSesion) inicioSesion.style.display = "";
            if (registro) registro.style.display = "";
        }
    }

    // Funci√≥n auxiliar para obtener el email del usuario
    function obtenerUsuarioEmail() {
        let usuarioEmail = localStorage.getItem("usuarioEmail");
        
        if (!usuarioEmail) {
            const usuarioLocal = localStorage.getItem("usuario");
            if (usuarioLocal) {
                try {
                    const usuarioObj = JSON.parse(usuarioLocal);
                    if (usuarioObj && typeof usuarioObj === 'object' && usuarioObj.correo) {
                        usuarioEmail = usuarioObj.correo;
                        localStorage.setItem("usuarioEmail", usuarioEmail);
                    }
                } catch (e) {
                    if (usuarioLocal.includes("@")) {
                        usuarioEmail = usuarioLocal;
                        localStorage.setItem("usuarioEmail", usuarioEmail);
                    }
                }
            }
        }
        
        return usuarioEmail;
    }

    // Funci√≥n para cargar pedidos desde el backend
    async function cargarPedidos() {
        const usuarioEmail = obtenerUsuarioEmail();
        if (!usuarioEmail) {
            document.getElementById('pedidos-container').innerHTML = `
                <div class="alert alert-warning text-center">
                    <i class="bi bi-exclamation-triangle"></i> Debes iniciar sesi√≥n para ver tus pedidos.
                </div>
            `;
            return;
        }

        try {
            const response = await fetch(`http://127.0.0.1:8000/ordenes?usuario_email=${encodeURIComponent(usuarioEmail)}`);
            
            if (!response.ok) {
                throw new Error('Error al cargar los pedidos');
            }

            const ordenes = await response.json();
            
            if (ordenes.length === 0) {
                document.getElementById('pedidos-container').innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="bi bi-inbox"></i> No tienes pedidos a√∫n. ¬°Haz tu primer pedido!
                    </div>
                `;
                return;
            }

            renderizarPedidos(ordenes);
            
        } catch (error) {
            console.error('Error al cargar pedidos:', error);
            document.getElementById('pedidos-container').innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="bi bi-exclamation-circle"></i> Error al cargar los pedidos. Por favor, intenta m√°s tarde.
                </div>
            `;
        }
    }

    // Funci√≥n para renderizar los pedidos
    function renderizarPedidos(ordenes) {
        const container = document.getElementById('pedidos-container');
        container.innerHTML = '';

        ordenes.forEach(orden => {
            const pedidoCard = crearCardPedido(orden);
            container.appendChild(pedidoCard);
        });

        // Mostrar mensaje de soporte
        document.getElementById('mensaje-soporte').style.display = 'block';

        // Inicializar sistema de estrellas y facturas despu√©s de renderizar
        inicializarSistemaEstrellas();
        inicializarSistemaFacturas();
    }

    // Funci√≥n para crear una tarjeta de pedido
    function crearCardPedido(orden) {
        const card = document.createElement('div');
        card.className = 'pedido-card';

        // Determinar color del borde y badge seg√∫n estado
        let borderColor = '#198754'; // Verde por defecto (completado)
        let badgeClass = 'bg-success';
        let badgeIcon = 'bi-check-circle-fill';
        let badgeText = 'Completado';

        if (orden.estado === 'pendiente') {
            borderColor = '#ffc107';
            badgeClass = 'bg-warning text-dark';
            badgeIcon = 'bi-hourglass-split';
            badgeText = 'En Proceso';
        } else if (orden.estado === 'cancelado') {
            borderColor = '#dc3545';
            badgeClass = 'bg-danger';
            badgeIcon = 'bi-x-circle-fill';
            badgeText = 'Cancelado';
        }

        card.style.borderLeftColor = borderColor;

        // Formatear fecha
        const fecha = orden.fecha_creacion ? new Date(orden.fecha_creacion).toLocaleDateString('es-CL', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        }) : 'Fecha no disponible';

        // Crear lista de productos
        const productosHTML = orden.productos.map(prod => {
            const cantidad = prod.cantidad || 1;
            const precio = prod.precio || 0;
            const subtotal = cantidad * precio;
            return `<li><i class="bi bi-dot"></i> ${prod.nombre} (x${cantidad}) - $${subtotal.toLocaleString('es-CL')}</li>`;
        }).join('');

        // ID corto para mostrar
        const ordenIdCorto = orden._id.substring(0, 8).toUpperCase();

        card.innerHTML = `
            <div class="pedido-header">
                <div>
                    <span class="pedido-id" style="color: ${borderColor};">Pedido #${ordenIdCorto}</span>
                    <div class="pedido-date">Fecha: ${fecha}</div>
                </div>
                <div>
                    <span class="badge badge-estado ${badgeClass}"><i class="bi ${badgeIcon}"></i> ${badgeText}</span>
                </div>
            </div>
            
            <ul class="item-list">
                ${productosHTML}
            </ul>
            
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                ${orden.estado === 'pagado' ? `
                <div class="rating d-flex align-items-center mb-2 mb-md-0" data-pedido-id="${orden._id}">
                    <span class="me-2 text-muted" style="font-size: 0.9rem;">Calificar:</span>
                    <i class="fa-solid fa-star" data-rating="1"></i>
                    <i class="fa-solid fa-star" data-rating="2"></i>
                    <i class="fa-solid fa-star" data-rating="3"></i>
                    <i class="fa-solid fa-star" data-rating="4"></i>
                    <i class="fa-solid fa-star" data-rating="5"></i>
                </div>
                ` : ''}
                
                <div class="d-flex align-items-center mt-2 mt-md-0">
                    <span class="pedido-total me-3">Total ${orden.estado === 'pagado' ? 'pagado' : ''}: <strong class="text-dark">$${orden.total.toLocaleString('es-CL')}</strong></span>
                    
                    ${orden.estado === 'pagado' ? `
                    <button class="btn btn-sm btn-success" onclick="verSeguimiento('${orden._id}')">
                        <i class="bi bi-map me-1"></i> Ver Seguimiento
                    </button>
                    <button class="btn btn-sm btn-outline-secondary btn-invoice btn-send-invoice ms-2" data-pedido-id="${orden._id}">
                        <i class="bi bi-envelope-fill me-1"></i> Factura
                    </button>
                    <button class="btn btn-sm btn-outline-success ms-2" onclick="reordenarPedido('${orden._id}')">
                        <i class="bi bi-arrow-clockwise"></i> Pedir de Nuevo
                    </button>
                    ` : orden.estado === 'pendiente' ? `
                    <button class="btn btn-sm btn-success" onclick="pagarPedidoDesdeHistorial('${orden._id}', ${orden.total})">
                        <i class="bi bi-credit-card me-1"></i> Pagar Pedido
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="verSeguimiento('${orden._id}')">
                        <i class="bi bi-map me-1"></i> Ver Seguimiento
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="cancelarPedido('${orden._id}')">
                        <i class="bi bi-x-circle me-1"></i> Cancelar Pedido
                    </button>
                    ` : `
                    <button class="btn btn-sm btn-outline-secondary" disabled><i class="bi bi-slash-circle"></i> No Reordenar</button>
                    `}
                </div>
            </div>
        `;

        return card;
    }

    // Funci√≥n para ver seguimiento del pedido
    async function verSeguimiento(ordenId) {
        // Obtener informaci√≥n del pedido y usuario
        const usuarioEmail = obtenerUsuarioEmail();
        let direccionEntrega = 'Santiago, Chile'; // Direcci√≥n por defecto
        
        // Intentar obtener la direcci√≥n del usuario
        try {
            const respUsuario = await fetch(`http://127.0.0.1:8000/usuarios/perfil/${encodeURIComponent(usuarioEmail)}`);
            if (respUsuario.ok) {
                const usuario = await respUsuario.json();
                if (usuario.domicilio) {
                    direccionEntrega = usuario.domicilio + ', Chile';
                }
            }
        } catch (error) {
            console.error('Error al obtener direcci√≥n del usuario:', error);
        }
        
        // Codificar la direcci√≥n para la URL del mapa
        const direccionCodificada = encodeURIComponent(direccionEntrega);
        
        // Crear modal de seguimiento
        const modalHTML = `
            <div class="modal fade" id="modalSeguimiento" tabindex="-1" aria-labelledby="modalSeguimientoLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="modalSeguimientoLabel">
                                <i class="bi bi-truck me-2"></i>Seguimiento del Pedido
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6 class="text-muted">ID del Pedido</h6>
                                    <p class="fw-bold">#${ordenId.substring(0, 8).toUpperCase()}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">Estado Actual</h6>
                                    <p><span class="badge bg-success">En Camino</span></p>
                                </div>
                            </div>
                            
                            <!-- Timeline de seguimiento -->
                            <div class="timeline mb-4">
                                <div class="timeline-item completed">
                                    <div class="timeline-marker bg-success">
                                        <i class="bi bi-check-lg text-white"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Pedido Confirmado</h6>
                                        <small class="text-muted">Tu pedido ha sido confirmado y est√° siendo preparado</small>
                                    </div>
                                </div>
                                
                                <div class="timeline-item completed">
                                    <div class="timeline-marker bg-success">
                                        <i class="bi bi-check-lg text-white"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Pago Procesado</h6>
                                        <small class="text-muted">El pago ha sido procesado exitosamente</small>
                                    </div>
                                </div>
                                
                                <div class="timeline-item active">
                                    <div class="timeline-marker bg-warning">
                                        <i class="bi bi-truck text-white"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">En Camino</h6>
                                        <small class="text-muted">Tu pedido est√° en camino a tu direcci√≥n</small>
                                    </div>
                                </div>
                                
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-light border">
                                        <i class="bi bi-house text-muted"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1 text-muted">Entregado</h6>
                                        <small class="text-muted">Tu pedido ser√° entregado pronto</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Perfil del Repartidor (Pedidos Ya) -->
                            <div class="mb-4">
                                <h6 class="mb-3"><i class="bi bi-person-badge me-2"></i>Repartidor Asignado</h6>
                                <div class="card border-danger" style="border-width: 2px;">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <img id="repartidor-avatar-${ordenId}" 
                                                     alt="Repartidor" 
                                                     class="rounded-circle" 
                                                     style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #dc3545;">
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="mb-1" id="repartidor-nombre-${ordenId}">Cargando...</h5>
                                                <div class="mb-2">
                                                    <span class="badge bg-warning text-dark me-2" id="repartidor-calificacion-${ordenId}">
                                                        <i class="bi bi-star-fill"></i> 4.8
                                                    </span>
                                                    <span class="text-muted small">
                                                        <i class="bi bi-check-circle-fill text-success"></i> Verificado
                                                    </span>
                                                </div>
                                                <p class="text-muted small mb-2">
                                                    <i class="bi bi-truck me-1"></i>En camino a tu ubicaci√≥n
                                                </p>
                                                <div class="d-flex align-items-center">
                                                    <img src="https://www.pedidosya.com/favicon.ico" 
                                                         alt="Pedidos Ya" 
                                                         style="width: 20px; height: 20px; margin-right: 8px;">
                                                    <span class="text-muted small">Entregado por Pedidos Ya</span>
                                                </div>
                                            </div>
                                            <div>
                                                <a href="https://www.pedidosya.com" 
                                                   target="_blank" 
                                                   class="btn btn-danger">
                                                    <i class="bi bi-box-arrow-up-right me-1"></i>Ver Perfil en Pedidos Ya
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mapa de Google Maps -->
                            <div class="mb-4">
                                <h6 class="mb-3"><i class="bi bi-geo-alt me-2"></i>Ubicaci√≥n de Entrega</h6>
                                <div class="map-container" style="width: 100%; height: 400px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <iframe
                                        width="100%"
                                        height="100%"
                                        style="border:0"
                                        loading="lazy"
                                        allowfullscreen
                                        referrerpolicy="no-referrer-when-downgrade"
                                        src="https://www.google.com/maps?q=${direccionCodificada}&output=embed&zoom=15">
                                    </iframe>
                                </div>
                                <small class="text-muted mt-2 d-block">
                                    <i class="bi bi-info-circle me-1"></i>Direcci√≥n de entrega: ${direccionEntrega}
                                </small>
                                <div class="mt-2">
                                    <a href="https://www.google.com/maps/search/?api=1&query=${direccionCodificada}" 
                                       target="_blank" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>Abrir en Google Maps
                                    </a>
                                </div>
                            </div>
                            
                            <div class="alert alert-success mt-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Informaci√≥n:</strong> Recibir√°s una notificaci√≥n cuando tu pedido est√© listo para entrega.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remover modal anterior si existe
        const modalAnterior = document.getElementById('modalSeguimiento');
        if (modalAnterior) {
            modalAnterior.remove();
        }

        // Agregar modal al body
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalSeguimiento'));
        modal.show();

        // Generar informaci√≥n aleatoria del repartidor basada en el ID del pedido
        generarInfoRepartidor(ordenId);
    }

    // Funci√≥n para generar informaci√≥n aleatoria del repartidor
    function generarInfoRepartidor(ordenId) {
        // Nombres y apellidos para generar combinaciones aleatorias
        const nombres = ['Carlos', 'Mar√≠a', 'Juan', 'Ana', 'Luis', 'Sof√≠a', 'Diego', 'Laura', 'Andr√©s', 'Carmen', 'Roberto', 'Patricia', 'Fernando', 'Gabriela', 'Miguel', 'Valentina'];
        const apellidos = ['Rodr√≠guez', 'Gonz√°lez', 'Mart√≠nez', 'L√≥pez', 'P√©rez', 'S√°nchez', 'Ram√≠rez', 'Torres', 'Flores', 'Rivera', 'G√≥mez', 'D√≠az', 'Cruz', 'Morales', 'Ortiz', 'Jim√©nez'];
        
        // Usar el ID del pedido como semilla para generar siempre el mismo repartidor para el mismo pedido
        const hash = ordenId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const nombreIndex = hash % nombres.length;
        const apellidoIndex = (hash * 7) % apellidos.length;
        
        const nombreRepartidor = nombres[nombreIndex];
        const apellidoRepartidor = apellidos[apellidoIndex];
        const nombreCompleto = `${nombreRepartidor} ${apellidoRepartidor}`;
        
        // Generar calificaci√≥n aleatoria entre 4.0 y 5.0
        const calificacion = (4.0 + (hash % 10) / 10).toFixed(1);
        
        // Actualizar el nombre
        const nombreEl = document.getElementById(`repartidor-nombre-${ordenId}`);
        if (nombreEl) {
            nombreEl.textContent = nombreCompleto;
        }
        
        // Actualizar la calificaci√≥n
        const calificacionEl = document.getElementById(`repartidor-calificacion-${ordenId}`);
        if (calificacionEl) {
            calificacionEl.innerHTML = `<i class="bi bi-star-fill"></i> ${calificacion}`;
        }
        
        // Actualizar el avatar con el nombre generado
        const avatarEl = document.getElementById(`repartidor-avatar-${ordenId}`);
        if (avatarEl) {
            const nombreCodificado = encodeURIComponent(nombreCompleto);
            avatarEl.src = `https://ui-avatars.com/api/?name=${nombreCodificado}&background=dc3545&color=fff&size=80&bold=true`;
        }
    }

    // Funci√≥n para cancelar un pedido
    async function cancelarPedido(ordenId) {
        if (!confirm('¬øEst√°s seguro de que deseas cancelar este pedido?\n\nEsta acci√≥n no se puede deshacer.')) {
            return;
        }

        try {
            const response = await fetch(`http://127.0.0.1:8000/ordenes/${ordenId}/cancelar`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({ detail: 'Error al cancelar el pedido' }));
                alert(error.detail || 'Error al cancelar el pedido');
                return;
            }

            const result = await response.json();
            
            // Mostrar mensaje de √©xito
            alert('‚úÖ Pedido cancelado exitosamente');
            
            // Recargar los pedidos para actualizar el estado
            await cargarPedidos();

        } catch (error) {
            console.error('Error al cancelar pedido:', error);
            alert('Error al cancelar el pedido. Por favor, intenta nuevamente.');
        }
    }

    // Funci√≥n para reordenar un pedido
    function reordenarPedido(ordenId) {
        // Esta funci√≥n puede implementarse para agregar los productos del pedido al carrito
        alert('Funci√≥n de reordenar en desarrollo. Pr√≥ximamente podr√°s agregar estos productos al carrito con un clic.');
    }

    // Funci√≥n para pagar un pedido desde el historial
    async function pagarPedidoDesdeHistorial(ordenId, total) {
        const usuarioEmail = obtenerUsuarioEmail();
        if (!usuarioEmail) {
            alert('Por favor, inicia sesi√≥n para continuar con el pago.');
            window.location.href = 'Inicio_Sesion.html';
            return;
        }

        try {
            // Obtener medios de pago del usuario
            const respMedios = await fetch(`http://127.0.0.1:8000/usuarios/${encodeURIComponent(usuarioEmail)}/medios_pago`);
            const mediosPago = respMedios.ok ? await respMedios.json() : [];

            // Si no tiene medios de pago, redirigir a agregar uno
            if (mediosPago.length === 0) {
                if (confirm('No tienes m√©todos de pago guardados. ¬øDeseas agregar uno ahora?')) {
                    window.location.href = `Metodo_de_Pago.html?orden_id=${ordenId}`;
                }
                return;
            }

            // Mostrar modal para seleccionar medio de pago
            mostrarModalPagoHistorial(ordenId, mediosPago, total);

        } catch (error) {
            console.error('Error al procesar pago:', error);
            alert('Error al procesar el pago. Por favor, intenta nuevamente.');
        }
    }

    // Funci√≥n para mostrar modal de selecci√≥n de pago desde historial
    function mostrarModalPagoHistorial(ordenId, mediosPago, total) {
        // Crear modal din√°micamente (reutilizar funciones del carrito)
        const modalHTML = `
            <div class="modal fade" id="modalPagoHistorial" tabindex="-1" aria-labelledby="modalPagoHistorialLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalPagoHistorialLabel">
                                <i class="fas fa-credit-card me-2"></i>Pagar Pedido
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Total a pagar: <span class="text-success fs-5">$${total.toLocaleString('es-CL')}</span></strong>
                            </div>
                            
                            <!-- Pasarelas de pago r√°pidas -->
                            <div class="mb-4">
                                <h6 class="mb-3">Pasarelas de Pago</h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-primary w-100 p-3" id="btn-mercadopago-historial" style="border: 2px solid #009ee3;">
                                            <img src="https://imgmp.mlstatic.com/org-img/MP3/API/logos/mercadopago.png" alt="Mercado Pago" style="height: 30px; margin-right: 10px;">
                                            <strong>Mercado Pago</strong>
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-dark w-100 p-3" id="btn-applepay-historial" style="background: #000; border: 2px solid #000;">
                                            <i class="fab fa-apple me-2" style="font-size: 1.5rem;"></i>
                                            <strong>Apple Pay</strong>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <!-- Tarjetas guardadas -->
                            <div class="mb-3">
                                <h6 class="mb-3">Tarjetas Guardadas</h6>
                                <div class="list-group" id="lista-medios-pago-historial">
                                    ${mediosPago.length > 0 ? mediosPago.map((medio, index) => `
                                        <label class="list-group-item">
                                            <input class="form-check-input me-2" type="radio" name="medioPagoHistorial" value="${medio._id}" ${index === 0 ? 'checked' : ''}>
                                            <strong>${medio.tipo === 'tarjeta' ? (medio.marca || 'Tarjeta') + ' ' + medio.numero_enmascarado : 'Transferencia'}</strong>
                                            <br>
                                            <small class="text-muted">Titular: ${medio.titular || '-'}${medio.vencimiento ? ' ¬∑ Vence: ' + medio.vencimiento : ''}</small>
                                        </label>
                                    `).join('') : '<p class="text-muted text-center">No tienes tarjetas guardadas</p>'}
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <a href="Metodo_de_Pago.html" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-plus me-1"></i> Agregar nueva tarjeta
                                </a>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success" id="btn-confirmar-pago-historial" style="${mediosPago.length > 0 ? '' : 'display: none;'}">
                                <i class="fas fa-check me-2"></i> Confirmar Pago
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remover modal anterior si existe
        const modalAnterior = document.getElementById('modalPagoHistorial');
        if (modalAnterior) {
            modalAnterior.remove();
        }

        // Agregar modal al body
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalPagoHistorial'));
        modal.show();

        // Manejar Mercado Pago
        document.getElementById('btn-mercadopago-historial').addEventListener('click', () => {
            simularMercadoPagoHistorial(ordenId, total, modal);
        });

        // Manejar Apple Pay
        document.getElementById('btn-applepay-historial').addEventListener('click', () => {
            simularApplePayHistorial(ordenId, total, modal);
        });

        // Manejar confirmaci√≥n de pago con tarjeta guardada
        const btnConfirmar = document.getElementById('btn-confirmar-pago-historial');
        if (mediosPago.length > 0) {
            btnConfirmar.style.display = 'block';
            btnConfirmar.addEventListener('click', async () => {
                const medioSeleccionado = document.querySelector('input[name="medioPagoHistorial"]:checked');
                if (!medioSeleccionado) {
                    alert('Por favor, selecciona un m√©todo de pago');
                    return;
                }

                const medioPagoId = medioSeleccionado.value;

                try {
                    const respPago = await fetch(`http://127.0.0.1:8000/ordenes/${ordenId}/pagar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ medio_pago_id: medioPagoId })
                    });

                    if (!respPago.ok) {
                        const error = await respPago.json().catch(() => ({ detail: 'Error al procesar el pago' }));
                        alert(error.detail || 'Error al procesar el pago');
                        return;
                    }

                    const pagoResult = await respPago.json();
                    modal.hide();
                    
                    // Mostrar mensaje de √©xito
                    alert('¬°Pago procesado exitosamente!');
                    
                    // Recargar los pedidos para actualizar el estado
                    await cargarPedidos();

                } catch (error) {
                    console.error('Error al confirmar pago:', error);
                    alert('Error al procesar el pago. Por favor, intenta nuevamente.');
                }
            });
        }
    }

    // Simular Mercado Pago desde historial
    function simularMercadoPagoHistorial(ordenId, total, modal) {
        const mpModalHTML = `
            <div class="modal fade" id="modalMercadoPagoHistorial" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header" style="background: linear-gradient(135deg, #009ee3 0%, #0073b1 100%); color: white;">
                            <h5 class="modal-title">
                                <img src="https://imgmp.mlstatic.com/org-img/MP3/API/logos/mercadopago.png" alt="Mercado Pago" style="height: 25px; margin-right: 10px;">
                                Mercado Pago
                            </h5>
                        </div>
                        <div class="modal-body text-center">
                            <div id="mp-hist-step-1">
                                <i class="fas fa-lock fa-3x text-primary mb-3"></i>
                                <h5>Iniciar sesi√≥n en Mercado Pago</h5>
                                <p class="text-muted">Conectando con tu cuenta de Mercado Pago...</p>
                                <div class="spinner-border text-primary mt-3" role="status"></div>
                            </div>
                            <div id="mp-hist-step-2" style="display: none;">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h5>Autenticaci√≥n exitosa</h5>
                                <p class="text-muted">Procesando pago de $${total.toLocaleString('es-CL')}...</p>
                                <div class="spinner-border text-success mt-3" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const mpModalAnterior = document.getElementById('modalMercadoPagoHistorial');
        if (mpModalAnterior) mpModalAnterior.remove();

        document.body.insertAdjacentHTML('beforeend', mpModalHTML);
        const mpModal = new bootstrap.Modal(document.getElementById('modalMercadoPagoHistorial'));
        mpModal.show();

        setTimeout(() => {
            document.getElementById('mp-hist-step-1').style.display = 'none';
            document.getElementById('mp-hist-step-2').style.display = 'block';
            
            setTimeout(async () => {
                mpModal.hide();
                modal.hide();
                
                const respPago = await fetch(`http://127.0.0.1:8000/ordenes/${ordenId}/pagar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ metodo_pago: 'mercadopago' })
                });

                if (respPago.ok) {
                    alert('¬°Pago procesado exitosamente con Mercado Pago!');
                    await cargarPedidos();
                }
            }, 2000);
        }, 2000);
    }

    // Simular Apple Pay desde historial
    function simularApplePayHistorial(ordenId, total, modal) {
        const apModalHTML = `
            <div class="modal fade" id="modalApplePayHistorial" tabindex="-1" data-bs-backdrop="static">
                <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content" style="border-radius: 20px; overflow: hidden;">
                        <div class="modal-header bg-dark text-white" style="border: none;">
                            <h5 class="modal-title"><i class="fab fa-apple me-2"></i>Apple Pay</h5>
                        </div>
                        <div class="modal-body text-center p-4">
                            <div id="ap-hist-step-1">
                                <i class="fab fa-apple fa-3x mb-3"></i>
                                <h6>Autenticaci√≥n con Face ID</h6>
                                <p class="text-muted small">Coloca tu dedo en el sensor</p>
                                <div class="spinner-border spinner-border-sm text-dark mt-3" role="status"></div>
                            </div>
                            <div id="ap-hist-step-2" style="display: none;">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h6>Pago autorizado</h6>
                                <p class="text-muted small">$${total.toLocaleString('es-CL')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const apModalAnterior = document.getElementById('modalApplePayHistorial');
        if (apModalAnterior) apModalAnterior.remove();

        document.body.insertAdjacentHTML('beforeend', apModalHTML);
        const apModal = new bootstrap.Modal(document.getElementById('modalApplePayHistorial'));
        apModal.show();

        setTimeout(() => {
            document.getElementById('ap-hist-step-1').style.display = 'none';
            document.getElementById('ap-hist-step-2').style.display = 'block';
            
            setTimeout(async () => {
                apModal.hide();
                modal.hide();
                
                const respPago = await fetch(`http://127.0.0.1:8000/ordenes/${ordenId}/pagar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ metodo_pago: 'applepay' })
                });

                if (respPago.ok) {
                    alert('¬°Pago procesado exitosamente con Apple Pay!');
                    await cargarPedidos();
                }
            }, 1500);
        }, 2000);
    }

    // Funci√≥n para inicializar sistema de estrellas
    function inicializarSistemaEstrellas() {
        const ratingContainers = document.querySelectorAll('.rating');

        ratingContainers.forEach(container => {
            const stars = container.querySelectorAll('.fa-star');
            const pedidoId = container.dataset.pedidoId;
            
            // 1. Cargar rating guardado (simulaci√≥n)
            let savedRating = localStorage.getItem('rating-' + pedidoId);
            if (savedRating) {
                updateVisualRating(container, parseInt(savedRating));
            }

            // 2. Manejar el clic (Guardar la calificaci√≥n)
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const ratingValue = parseInt(this.dataset.rating);
                    
                    // Almacenar el rating (usando localStorage como simulaci√≥n)
                    localStorage.setItem('rating-' + pedidoId, ratingValue);
                    
                    // Actualizar la visualizaci√≥n de las estrellas
                    updateVisualRating(container, ratingValue);
                });

                // 3. Manejar el mouseover (Previsualizaci√≥n)
                star.addEventListener('mouseover', function() {
                    const ratingValue = parseInt(this.dataset.rating);
                    
                    // Solo si no ha sido calificado, o si se quiere cambiar
                    stars.forEach(s => {
                        s.classList.remove('active');
                        if (parseInt(s.dataset.rating) <= ratingValue) {
                            s.classList.add('active');
                        }
                    });
                });

                // 4. Manejar el mouseout (Volver al estado guardado o vac√≠o)
                star.addEventListener('mouseout', function() {
                    const currentRating = localStorage.getItem('rating-' + pedidoId) || 0;
                    updateVisualRating(container, parseInt(currentRating));
                });
            });
        });
    }

    // Funci√≥n para inicializar sistema de facturas
    function inicializarSistemaFacturas() {
        const invoiceButtons = document.querySelectorAll('.btn-send-invoice');
        
        invoiceButtons.forEach(button => {
            // Cargar estado de factura (simulaci√≥n)
            const pedidoId = button.dataset.pedidoId;
            if(localStorage.getItem('invoice-sent-' + pedidoId) === 'true') {
                disableInvoiceButton(button, 'Enviada');
            } else {
                 button.addEventListener('click', sendInvoice);
            }
        });
    }

    // Funci√≥n de inicializaci√≥n principal
    document.addEventListener('DOMContentLoaded', async () => {
        // Verificar sesi√≥n antes de continuar
        if (!verificarSesion()) {
            return; // Detener la ejecuci√≥n si no hay sesi√≥n
        }
        
        // Actualizar visibilidad de enlaces del navbar seg√∫n sesi√≥n
        actualizarEnlacesNavbar();
        
        // Cargar pedidos desde el backend
        await cargarPedidos();
    });

    /**
     * Actualiza la visualizaci√≥n de las estrellas en base al valor num√©rico.
     * @param {HTMLElement} container - El div con la clase .rating.
     * @param {number} ratingValue - El n√∫mero de estrellas a iluminar.
     */
    function updateVisualRating(container, ratingValue) {
        const stars = container.querySelectorAll('.fa-star');
        stars.forEach(star => {
            star.classList.remove('active');
            if (parseInt(star.dataset.rating) <= ratingValue) {
                star.classList.add('active');
            }
        });
    }

    /**
     * Simula el env√≠o de la factura por correo electr√≥nico.
     * @param {Event} e - El evento de clic.
     */
    function sendInvoice(e) {
        const button = e.currentTarget;
        const pedidoId = button.dataset.pedidoId;

        // 1. Simular el proceso de env√≠o
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';

        // 2. Simular el retraso del env√≠o (ej: 1 segundo)
        setTimeout(() => {
            // 3. Almacenar el estado (simulaci√≥n)
            localStorage.setItem('invoice-sent-' + pedidoId, 'true');

            // 4. Actualizar la interfaz
            disableInvoiceButton(button, 'Enviada');
            
            // 5. Mostrar confirmaci√≥n (usamos alert simple)
            alert(`Factura del Pedido #${pedidoId} enviada exitosamente a tu correo registrado.`);
        }, 1000); 
    }

    /**
     * Deshabilita el bot√≥n de factura y actualiza su texto.
     * @param {HTMLElement} button - El bot√≥n de factura.
     * @param {string} text - El texto a mostrar.
     */
    function disableInvoiceButton(button, text) {
        button.disabled = true;
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-light');
        button.innerHTML = `<i class="bi bi-envelope-check-fill me-1"></i> ${text}`;
        button.removeEventListener('click', sendInvoice); // Eliminar el listener para evitar clics dobles
    }
    
    // El resto de funciones del carrito (formatCurrency, getCart, saveCart, etc.) 
    // est√°n abajo, pero deben estar dentro del tag <script> para funcionar.

    /**
     * Formatea un n√∫mero entero (ej: 4500) a formato de moneda (ej: $4.500).
     * @param {string|number} value - El valor num√©rico.
     * @returns {string} El valor formateado como moneda CLP (Peso Chileno, sin decimales).
     */
    function formatCurrency(value) {
        const num = parseInt(value); 
        if (isNaN(num)) return "$0";

        return new Intl.NumberFormat('es-CL', {
            style: 'currency',
            currency: 'CLP',
            minimumFractionDigits: 0
        }).format(num);
    }

    // --- Utilidades para Carrito (Persistencia) ---
    function getCart() {
        const cart = localStorage.getItem('shoppingCart');
        return cart ? JSON.parse(cart) : [];
    }

    function saveCart(cartArray) {
        localStorage.setItem('shoppingCart', JSON.stringify(cartArray));
        updateCartDisplay(); 
    }

    // --- Actualizaci√≥n de la Interfaz del Carrito (Dropdown) ---
    function updateCartDisplay() {
        const cart = getCart();
        const cartProductsDiv = document.getElementById('cart-products'); 
        const cartTotalSpan = document.getElementById('cart-total'); 
        const notificationBadge = document.getElementById('cart-notification-badge'); 

        if (!cartProductsDiv || !cartTotalSpan || !notificationBadge) return;
        
        let total = 0;

        // 1. Limpiar la lista actual
        cartProductsDiv.innerHTML = '';

        // 2. Si hay productos, construir la lista
        if (cart.length > 0) {
            cart.forEach(item => {
                const priceValue = parseInt(item.price);
                const subtotal = priceValue * item.quantity;
                total += subtotal;

                const productItem = document.createElement('li');
                productItem.classList.add('dropdown-item', 'd-flex', 'justify-content-between', 'align-items-center', 'py-2');
                
                productItem.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2">${item.quantity}x</span>
                        <span class="text-truncate" style="max-width: 150px;">${item.name}</span>
                    </div>
                    <span class = "ms-auto">${formatCurrency(subtotal)}</span>
                    <button class="btn btn-sm btn-danger remove-item-btn ms-2" data-product-id="${item.id}">&times;</button>
                `;
                cartProductsDiv.appendChild(productItem);
            });
            
            notificationBadge.classList.add('active');

        } else {
            cartProductsDiv.innerHTML = '<li class="dropdown-item text-muted text-center" id="empty-cart-message">El carrito est√° vac√≠o.</li>';
            notificationBadge.classList.remove('active');
        }

        // 3. Actualizar el total del dropdown
        cartTotalSpan.textContent = formatCurrency(total);

        // 4. Configurar eventos para eliminar (para los botones reci√©n creados)
        document.querySelectorAll('.remove-item-btn').forEach(button => {
            button.addEventListener('click', removeItemFromCart);
        });
    }

    // --- L√≥gica de Eliminar Producto (mantenida de tu c√≥digo anterior) ---
    function removeItemFromCart(e) {
        e.stopPropagation();
        
        const idToRemove = e.currentTarget.dataset.productId;
        let cart = getCart();

        const existingItemIndex = cart.findIndex(item => item.id === idToRemove);

        if (existingItemIndex > -1) {
            let item = cart[existingItemIndex];
        
            item.quantity -= 1;

            if (item.quantity <= 0) {
                cart.splice(existingItemIndex, 1);
            }
        }

        saveCart(cart);
    }
    
    // --- L√≥gica de Agregar Producto (mantenida de tu c√≥digo anterior) ---
    // (Aseg√∫rate de tener botones con la clase '.btn-add-to-cart' en Productos.html para que esto funcione)
    function addItemToCart(e) {
        e.preventDefault();
        const button = e.currentTarget;

        const id = button.dataset.productId;
        const img = button.dataset.productImg;
        const name = button.dataset.productName;
        const price = button.dataset.productPrice; 
        
        let cart = getCart();
        let existingItem = cart.find(item => item.id === id);

        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({
                id: id,
                img: img, 
                name: name,
                price: price, // Valor num√©rico limpio
                quantity: 1
            });
        }

        saveCart(cart);
    }

</script>
<script src="js/carrito-global.js"></script>
</body>
</html>
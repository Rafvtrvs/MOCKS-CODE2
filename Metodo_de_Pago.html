<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Método de Pago</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .payment-card {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        .form-check-input:checked {
            background-color: #198754;
            border-color: #198754;
        }
        .icon-card {
            font-size: 1.5rem;
            color: #6c757d;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold fs-3 text-success"  href="Index.html">LIBRE & RICO</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="Index.html">Inicio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="Productos.html">Productos</a>
                </li>
                <li class="nav-item" id="nav-inicio-sesion">
                    <a class="nav-link" href="Inicio_Sesion.html">Inicio Sesión</a>
                </li>
                <li class="nav-item" id="nav-registro">
                    <a class="nav-link" href="Registro.html">Registrate</a>
                </li>
                <li class="nav-item" id="nav-portal-empleados" style="display: none;">
                    <a class="nav-link" href="Portal_de_empleados.html">Portal de empleados</a>
                </li>
                <li class="nav-item" id="nav-historial-pedidos" style="display: none;">
                    <a class="nav-link" href="Historial-pedidos.html">Historial de pedidos</a>
                </li>
                <li class="nav-item" id="nav-analisis-ventas" style="display: none;">
                    <a class="nav-link" href="Historial_pedidos.html">Análisis de Ventas</a>
                </li>
                <li class="nav-item" id="nav-administrar-productos" style="display: none;">
                    <a class="nav-link" href="Administrar_productos.html">Administrar Productos</a>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link text-success" href="Perfil.html"><i class="fas fa-user-circle fa-lg"></i></a>
                </li>
                <li class = "nav-item">
                    <a class="nav-link text-success" href="favoritos.html"><i class= "fa-solid fa-heart fa-lg"></i></a> 
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <div class="payment-card">
        <h2 class="text-center mb-4 text-success"><i class="fas fa-credit-card me-2"></i> Añadir Método de Pago</h2>
        
        <form id="paymentForm">
            <div class="mb-4">
                <label class="form-label fw-bold">Selecciona el método:</label>
                <div class="d-flex justify-content-around">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="cardRadio" value="card" checked>
                        <label class="form-check-label" for="cardRadio">
                            <i class="fas fa-credit-card icon-card"></i> Tarjeta
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="transferRadio" value="transfer">
                        <label class="form-check-label" for="transferRadio">
                            <i class="fas fa-university icon-card"></i> Transferencia
                        </label>
                    </div>
                </div>
            </div>

            <div id="cardFields">
                <div class="mb-3">
                    <label for="cardNumber" class="form-label">Número de Tarjeta</label>
                    <input type="text" class="form-control" id="cardNumber" placeholder="XXXX XXXX XXXX XXXX" required maxlength="19">
                </div>
                
                <div class="mb-3">
                    <label for="cardName" class="form-label">Nombre en la Tarjeta</label>
                    <input type="text" class="form-control" id="cardName" placeholder="Como aparece en la tarjeta" required>
                </div>

                <div class="row">
                    <div class="col-6 mb-3">
                        <label for="cardExpiry" class="form-label">Vencimiento</label>
                        <input type="text" class="form-control" id="cardExpiry" placeholder="MM/AA" required maxlength="5">
                    </div>
                    <div class="col-6 mb-3">
                        <label for="cardCVC" class="form-label">CVV</label>
                        <input type="text" class="form-control" id="cardCVC" placeholder="XXX" required maxlength="4">
                    </div>
                </div>
            </div>
            
            <div id="transferFields" style="display:none;">
                <p class="alert alert-info">Al seleccionar transferencia, se te proporcionarán los datos bancarios al finalizar la compra.</p>
                <div class="mb-3">
                    <label for="transferAlias" class="form-label">Alias de la Cuenta</label>
                    <input type="text" class="form-control" id="transferAlias" placeholder="Mi cuenta principal">
                    <div class="form-text">Este es solo un nombre de referencia.</div>
                </div>
            </div>

            <hr>
            
            <div class="d-grid">
                <button type="submit" class="btn btn-success btn-lg">Guardar Método de Pago</button>
            </div>
        </form>

        <div class="mt-4 d-grid">
            <button id="btnToggleEdit" class="btn btn-outline-success" style="display:none;">Editar medios de pago</button>
        </div>

        <div id="editSection" class="mt-3" style="display:none;">
            <h5 class="mb-3 text-success">Tus medios de pago</h5>
            <div id="listaMedios" class="list-group"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 1. Obtener elementos
    const cardRadio = document.getElementById('cardRadio');
    const transferRadio = document.getElementById('transferRadio');
    const cardFields = document.getElementById('cardFields');
    const transferFields = document.getElementById('transferFields');
    const paymentForm = document.getElementById('paymentForm');

    // 2. Función para mostrar/ocultar campos
    function togglePaymentFields() {
        if (cardRadio.checked) {
            cardFields.style.display = 'block';
            transferFields.style.display = 'none';
        } else if (transferRadio.checked) {
            cardFields.style.display = 'none';
            transferFields.style.display = 'block';
        }
    }

    // 3. Agregar listeners para cambiar la vista
    cardRadio.addEventListener('change', togglePaymentFields);
    transferRadio.addEventListener('change', togglePaymentFields);

    // Utilidades de usuario
    function obtenerUsuarioEmail() {
        let usuarioEmail = localStorage.getItem('usuarioEmail');
        if (!usuarioEmail) {
            const usuarioLocal = localStorage.getItem('usuario');
            if (usuarioLocal) {
                try {
                    const u = JSON.parse(usuarioLocal);
                    if (u && u.correo) {
                        usuarioEmail = u.correo;
                        localStorage.setItem('usuarioEmail', usuarioEmail);
                    }
                } catch {}
            }
        }
        return usuarioEmail;
    }

    // Render de lista
    function renderMedios(medios) {
        const cont = document.getElementById('listaMedios');
        cont.innerHTML = '';
        if (!medios || medios.length === 0) {
            cont.innerHTML = '<div class="text-muted">No tienes medios de pago guardados.</div>';
            return;
        }
        medios.forEach(m => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            const label = m.tipo === 'tarjeta' ? `${m.marca || 'Tarjeta'} ${m.numero_enmascarado}` : (m.marca || 'Medio');
            item.innerHTML = `
                <div>
                    <div class="fw-semibold">${label}</div>
                    <div class="small text-muted">Titular: ${m.titular || '-'}${m.vencimiento ? ' · Vence: ' + m.vencimiento : ''}</div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" data-id="${m._id}" data-action="edit">Editar</button>
                    <button class="btn btn-sm btn-outline-danger" data-id="${m._id}" data-action="del">Eliminar</button>
                </div>
            `;
            cont.appendChild(item);
        });
    }

    async function cargarMedios() {
        const correo = obtenerUsuarioEmail();
        if (!correo) return;
        const resp = await fetch(`http://127.0.0.1:8000/usuarios/${encodeURIComponent(correo)}/medios_pago`);
        if (!resp.ok) return;
        const datos = await resp.json();
        renderMedios(datos);
    }

    async function agregarMedio(formData) {
        const correo = obtenerUsuarioEmail();
        if (!correo) {
            alert('Inicia sesión para guardar un método de pago.');
            return;
        }
        const resp = await fetch(`http://127.0.0.1:8000/usuarios/${encodeURIComponent(correo)}/medios_pago`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        if (!resp.ok) {
            const err = await resp.json().catch(()=>({detail:'Error'}));
            alert(err.detail || 'No se pudo guardar el medio de pago');
            return;
        }
        await cargarMedios();
        document.getElementById('btnToggleEdit').style.display = '';
        document.getElementById('editSection').style.display = '';
        alert('¡Método guardado con éxito!');
    }

    async function actualizarMedio(id, cambios) {
        const correo = obtenerUsuarioEmail();
        const resp = await fetch(`http://127.0.0.1:8000/usuarios/${encodeURIComponent(correo)}/medios_pago/${encodeURIComponent(id)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cambios)
        });
        if (!resp.ok) {
            const err = await resp.json().catch(()=>({detail:'Error'}));
            alert(err.detail || 'No se pudo actualizar');
            return;
        }
        await cargarMedios();
    }

    async function eliminarMedio(id) {
        const correo = obtenerUsuarioEmail();
        const resp = await fetch(`http://127.0.0.1:8000/usuarios/${encodeURIComponent(correo)}/medios_pago/${encodeURIComponent(id)}`, {
            method: 'DELETE'
        });
        if (!resp.ok) {
            const err = await resp.json().catch(()=>({detail:'Error'}));
            alert(err.detail || 'No se pudo eliminar');
            return;
        }
        await cargarMedios();
    }

    // Envío del formulario real
    paymentForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const method = document.querySelector('input[name="paymentMethod"]:checked').value;
        if (method === 'card') {
            const numero = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const titular = document.getElementById('cardName').value.trim();
            const vencimiento = document.getElementById('cardExpiry').value.trim();
            const marca = '';
            await agregarMedio({ tipo: 'tarjeta', numero, titular, vencimiento, marca });
        } else {
            const alias = document.getElementById('transferAlias').value.trim();
            await agregarMedio({ tipo: 'transferencia', titular: alias, marca: 'Transferencia' });
        }
        paymentForm.reset();
        togglePaymentFields();
    });

    // Toggle lista de edición
    document.getElementById('btnToggleEdit').addEventListener('click', async function() {
        const sec = document.getElementById('editSection');
        const visible = sec.style.display !== 'none';
        if (!visible) await cargarMedios();
        sec.style.display = visible ? 'none' : '';
    });

    // Delegación para editar/eliminar
    document.getElementById('listaMedios').addEventListener('click', async function(e) {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        if (action === 'edit') {
            const nuevoTitular = prompt('Nuevo titular (opcional):', '');
            const nuevoVenc = prompt('Nuevo vencimiento MM/AA (opcional):', '');
            const cambios = {};
            if (nuevoTitular) cambios.titular = nuevoTitular;
            if (nuevoVenc) cambios.vencimiento = nuevoVenc;
            if (Object.keys(cambios).length === 0) return;
            await actualizarMedio(id, cambios);
        } else if (action === 'del') {
            if (confirm('¿Eliminar este medio de pago?')) {
                await eliminarMedio(id);
            }
        }
    });

    // Init
    document.addEventListener('DOMContentLoaded', async function() {
        const correo = obtenerUsuarioEmail();
        if (correo) {
            document.getElementById('btnToggleEdit').style.display = '';
            await cargarMedios();
        }
        // Navbar visibility for super users
        let usuarioEmail = localStorage.getItem('usuarioEmail');
        if (!usuarioEmail) {
            const uLocal = localStorage.getItem('usuario');
            if (uLocal) {
                try { const uObj = JSON.parse(uLocal); if (uObj && uObj.correo) { usuarioEmail = uObj.correo; localStorage.setItem('usuarioEmail', usuarioEmail); } } catch {}
            }
        }
        let esSuperUser = false;
        const uLocal2 = localStorage.getItem('usuario');
        if (uLocal2) { try { const uObj = JSON.parse(uLocal2); if (uObj && uObj.es_super_usuario === true) esSuperUser = true; } catch {} }
        if (!esSuperUser && usuarioEmail) {
            const SUPER_USUARIOS = ["rafaarodriguezjr@gmail.com", "alguien@example.com"];
            esSuperUser = SUPER_USUARIOS.some(e => e.toLowerCase() === usuarioEmail.toLowerCase());
        }
        const portalEmpleados = document.getElementById('nav-portal-empleados');
        if (portalEmpleados) portalEmpleados.style.display = esSuperUser ? '' : 'none';
        const historialPedidos = document.getElementById('nav-historial-pedidos');
        if (historialPedidos) historialPedidos.style.display = (usuarioEmail || esSuperUser) ? '' : 'none';
        const analisisVentas = document.getElementById('nav-analisis-ventas');
        if (analisisVentas) analisisVentas.style.display = esSuperUser ? '' : 'none';
        const adminProductos = document.getElementById('nav-administrar-productos');
        if (adminProductos) adminProductos.style.display = esSuperUser ? '' : 'none';
        const inicioSesion = document.getElementById('nav-inicio-sesion');
        const registro = document.getElementById('nav-registro');
        if (usuarioEmail) {
            if (inicioSesion) inicioSesion.style.display = 'none';
            if (registro) registro.style.display = 'none';
        } else {
            if (inicioSesion) inicioSesion.style.display = '';
            if (registro) registro.style.display = '';
        }
    });
    
    // 5. (Opcional) Formatear el campo de tarjeta para agregar espacios (UX)
    document.getElementById('cardNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, ''); // Eliminar espacios existentes
        let formattedValue = '';
        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) {
                formattedValue += ' ';
            }
            formattedValue += value[i];
        }
        e.target.value = formattedValue;
    });

</script>
<script src="js/carrito-global.js"></script>
</body>
</html>
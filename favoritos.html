<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libre y Rico - Mis Favoritos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<style>
    /* Estilos del Sticky Footer */
    html { height: 100%; }
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
        background-color: #f8f9fa; /* Fondo gris claro */
    }
    .content-wrapper { flex: 1; }
    footer { flex-shrink: 0; }
    
    /* Estilo para hover en nav (verde #198754) */
    .nav-link:hover {
        color: #198754 !important;
        cursor: pointer;
    }
    /* Estilo para los enlaces sociales (quitar subrayado) */
    .social-icon-link {
        text-decoration: none !important; 
    }

    /* Estilo espec√≠fico para las Cards de producto */
    .product-card {
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%; /* Asegura que todas las cards tengan la misma altura */
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    .card-img-top {
        height: 200px;
        object-fit: cover;
        width: 100%;
    }
    .btn-favorite {
        color: #dc3545; /* Rojo de Font Awesome */
        font-size: 1.25rem;
        transition: color 0.1s;
    }
    /* Icono relleno para indicar que es favorito */
    .btn-favorite i.fas {
        color: #dc3545;
    }

    /* Estilo para hacer el badge m√°s peque√±o */
    .badge {
        font-size: 0.65rem !important;
        padding: 0.15rem 0.35rem !important;
        line-height: 1.2;
    }

     /* Estilo para el punto de notificaci√≥n roja del carrito */
    .cart-notification-dot {
            /* Dise√±o del punto */
            height: 10px;
            width: 10px;
            background-color: #dc3545; /* Rojo de Bootstrap (danger) */
            border-radius: 50%;
            
            /* Posicionamiento */
            position: absolute;
            top: 3px; /* Ajusta la posici√≥n verticalmente */
            right: 0px; /* Ajusta la posici√≥n horizontalmente */
            border: 1px solid white; /* Borde blanco para que se vea mejor */
            
            /* Inicialmente oculto */
            display: none; 
   }

        /* Clase para mostrar el punto */
    .cart-notification-dot.active {
            display: block;
    }

        /* El √≠cono del carrito debe ser el contenedor relativo */
   .position-relative {
            position: relative !important;
   }
   .nav-link i {
            transition: all 0.3s ease; /* Transici√≥n suave */
   }
   .nav-link i:hover {
            color:#28a745;
            transform: scale(1.3); 
            cursor: pointer;
   }
   .nav-link:hover {
            color: #28a745;
            cursor: pointer;
   }
</style>
<body>

<div class="content-wrapper">


<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold fs-3 text-success"  href="Index.html">LIBRE & RICO</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="Index.html">Inicio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="Productos.html">Productos</a>
                </li>
                <li class="nav-item" id="nav-inicio-sesion">
                    <a class="nav-link" href="#">Inicio Sesi√≥n</a>
                </li>
                 <li class="nav-item" id="nav-registro">
                    <a class="nav-link" href="Registro.html">Registrate</a>
                </li>
                 <li class="nav-item" id="nav-portal-empleados" style="display: none;">
                    <a class="nav-link" href="Portal_de_empleados.html">Portal de empleados</a>
                </li>
                <li class="nav-item" id="nav-historial-pedidos" style="display: none;">
                    <a class="nav-link" href="Historial-pedidos.html">Historial de pedidos</a>
                </li>
            </ul>
            <ul class="navbar-nav">
                 <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link text-success" href="#" id="cartDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fas fa-shopping-cart fa-lg position-relative"></i>
                      <span class="cart-notification-dot" id="cart-notification-badge"></span>
                    </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="cartDropdown" id="cart-items-container" style="min-width: 300px;">
                    <li class="dropdown-header text-center">üõí Carrito de Compras</li>
                    <div id="cart-products">
                      <li class="dropdown-item text-muted text-center" id="empty-cart-message">El carrito est√° vac√≠o.</li>
                    </div>
        
                    <li><hr class="dropdown-divider"></li>
        
                    <li class="d-flex justify-content-between p-2 fw-bold bg-light">
                      <span class = "text-success">Total:</span>
                      <span id="cart-total" class = "text-success">$0.00</span>
                    </li>
                      <li class="p-2">
                      <a href="Carrito.html" class="btn btn-success w-100">Finalizar Compra</a>
                    </li>
                 </ul>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link text-success" href="Perfil.html"><i class="fas fa-user-circle fa-lg"></i></a>
                </li>
                <li class = "nav-item">
                    <a class="nav-link text-success" href="favoritos.html"><i class= "fa-solid fa-heart fa-lg"></i></a> 
                </li>
            </ul>
        </div>
    </div>
</nav>
    <div class="container my-5">
        <h1 class="text-center mb-5 fw-bold text-success">
            <i class="fas fa-heart me-2"></i> Mis Productos Favoritos
        </h1>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4" id="favorites-container"></div>
    </div>
    </div> <footer class="bg-success text-white p-4">
    <div class="container text-center">
        <p>&copy; 2025 Libre y Rico. Todos los derechos reservados.</p>
        <div class="mt-3">
            <h5 class="text-uppercase">S√≠guenos</h5>
            <a href="https://www.instagram.com/rafvtrvs" target="_blank" class="text-white mx-2 social-icon-link">
                <i class="fab fa-instagram fa-lg"></i>
                <span class="visually-hidden">Instagram</span>
            </a>
            <a href="#" target="_blank" class="text-white mx-2 social-icon-link"> 
                <i class="fab fa-facebook fa-lg"></i>
                <span class="visually-hidden">Facebook</span>
            </a>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
   // ========================================
// SISTEMA DE FAVORITOS CON MONGODB
// ========================================

let favoritosGlobal = [];
let carritoGlobal = [];

// Funci√≥n auxiliar para obtener el email del usuario
function obtenerUsuarioEmail() {
    let usuarioEmail = localStorage.getItem("usuarioEmail");
    
    if (!usuarioEmail) {
        const usuarioLocal = localStorage.getItem("usuario");
        if (usuarioLocal) {
            try {
                const usuarioObj = JSON.parse(usuarioLocal);
                if (usuarioObj && typeof usuarioObj === 'object' && usuarioObj.correo) {
                    usuarioEmail = usuarioObj.correo;
                    localStorage.setItem("usuarioEmail", usuarioEmail);
                }
            } catch (e) {
                if (usuarioLocal.includes("@")) {
                    usuarioEmail = usuarioLocal;
                    localStorage.setItem("usuarioEmail", usuarioEmail);
                }
            }
        }
    }
    
    return usuarioEmail;
}

// Inicializar carrito para el dropdown
async function inicializarCarrito() {
    try {
        const usuarioEmail = obtenerUsuarioEmail();
        const url = usuarioEmail 
            ? `http://127.0.0.1:8000/carrito?usuario_email=${encodeURIComponent(usuarioEmail)}`
            : "http://127.0.0.1:8000/carrito";
        
        const response = await fetch(url);
        carritoGlobal = await response.json();
        actualizarDropdownCarrito();
    } catch (error) {
        console.error("Error al cargar carrito:", error);
    }
}

// Actualizar dropdown del carrito
function actualizarDropdownCarrito() {
    const cartProductsContainer = document.getElementById("cart-products");
    const cartTotal = document.getElementById("cart-total");
    const cartNotificationBadge = document.getElementById("cart-notification-badge");
    
    if (!cartProductsContainer) return;
    
    cartProductsContainer.innerHTML = "";
    
    if (carritoGlobal.length === 0) {
        cartProductsContainer.innerHTML = '<li class="dropdown-item text-muted text-center">El carrito est√° vac√≠o.</li>';
        if (cartTotal) cartTotal.textContent = "$0";
        if (cartNotificationBadge) cartNotificationBadge.classList.remove("active");
    } else {
        let total = 0;
        
        carritoGlobal.forEach((producto) => {
            const cantidad = producto.cantidad || 1;
            const subtotal = producto.precio * cantidad;
            total += subtotal;
            
            const item = document.createElement("li");
            item.className = "dropdown-item d-flex align-items-center justify-content-between py-2";
            item.innerHTML = `
                <div class="d-flex align-items-center flex-grow-1">
                    <img src="${producto.imagen || 'https://via.placeholder.com/40'}" 
                         width="40" height="40" 
                         class="rounded me-2" 
                         style="object-fit: cover;">
                    <div class="flex-grow-1">
                        <div class="fw-bold text-dark" style="font-size: 0.9rem;">${producto.nombre}</div>
                        <small class="text-muted">
                            ${cantidad} x $${producto.precio.toLocaleString('es-CL')}
                        </small>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-danger ms-2" 
                        onclick="eliminarDelCarritoDropdown('${producto._id}')" 
                        title="Eliminar">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            cartProductsContainer.appendChild(item);
        });
        
        if (cartTotal) cartTotal.textContent = `$${total.toLocaleString('es-CL')}`;
        if (cartNotificationBadge) cartNotificationBadge.classList.add("active");
    }
}

// Eliminar del carrito
async function eliminarDelCarritoDropdown(idProducto) {
    try {
        const usuarioEmail = obtenerUsuarioEmail();
        const url = usuarioEmail 
            ? `http://127.0.0.1:8000/carrito/${idProducto}?usuario_email=${encodeURIComponent(usuarioEmail)}`
            : `http://127.0.0.1:8000/carrito/${idProducto}`;
        
        const response = await fetch(url, {
            method: "DELETE"
        });

        if (response.ok) {
            await inicializarCarrito();
        }
    } catch (error) {
        console.error("Error al eliminar del carrito:", error);
    }
}

// Cargar favoritos desde MongoDB
async function cargarFavoritos() {
    try {
        console.log("Cargando favoritos desde MongoDB...");
        const usuarioEmail = obtenerUsuarioEmail();
        const url = usuarioEmail 
            ? `http://127.0.0.1:8000/favoritos?usuario_email=${encodeURIComponent(usuarioEmail)}`
            : "http://127.0.0.1:8000/favoritos";
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        favoritosGlobal = await response.json();
        
        console.log("Favoritos cargados exitosamente:", favoritosGlobal);
        console.log("Cantidad de favoritos:", favoritosGlobal.length);
        
        renderizarFavoritos();
    } catch (error) {
        console.error("Error al cargar favoritos:", error);
        const favoritesContainer = document.getElementById('favorites-container');
        if (favoritesContainer) {
            favoritesContainer.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger text-center" role="alert">
                        <strong>Error al cargar los favoritos</strong><br>
                        Verifica que el backend est√© corriendo en http://127.0.0.1:8000
                        <br><small>Error: ${error.message}</small>
                    </div>
                </div>
            `;
        }
    }
}

// Renderizar favoritos
function renderizarFavoritos() {
    const favoritesContainer = document.getElementById('favorites-container');
    
    if (!favoritesContainer) {
        console.error("No se encontr√≥ el contenedor de favoritos");
        return;
    }
    
    favoritesContainer.innerHTML = '';
    console.log("Renderizando favoritos. Total:", favoritosGlobal.length);

    if (favoritosGlobal.length === 0) {
        console.log("No hay favoritos para mostrar");
        favoritesContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-success text-center" role="alert">
                    A√∫n no tienes productos favoritos. ¬°Explora la 
                    <a href="Index.html" class="alert-link">p√°gina de inicio</a> o 
                    <a href="Productos.html" class="alert-link">Productos</a> para a√±adir algunos!
                </div>
            </div>
        `;
        return;
    }

    favoritosGlobal.forEach(producto => {
        const col = document.createElement('div');
        col.className = 'col';
        col.dataset.productId = producto._id;

        // Verificar si est√° en el carrito
        const estaEnCarrito = carritoGlobal.some(c => c.nombre === producto.nombre);

        col.innerHTML = `
            <div class="card product-card shadow-sm border-0">
                <img src="${producto.imagen || 'https://via.placeholder.com/300'}" 
                     class="card-img-top" 
                     alt="${producto.nombre}">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fw-bold">${producto.nombre}</h5>
                    <p class="card-text text-muted">${producto.categoria}</p>
                    <span class="badge ${obtenerClaseBadge(producto.estado)} mb-2">${producto.estado || "N/A"}</span>
                    <p class="fs-4 text-success mt-auto fw-bold">$${producto.precio.toLocaleString('es-CL')}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-success ${estaEnCarrito ? 'disabled' : ''}" 
                                onclick="agregarAlCarritoDesdeFavoritos('${producto._id}', '${producto.nombre.replace(/'/g, "\\'")}', ${producto.precio}, '${(producto.imagen || '').replace(/'/g, "\\'")}')">
                            <i class="fas fa-cart-plus me-1"></i> 
                            ${estaEnCarrito ? 'En el carrito' : 'A√±adir al carrito'}
                        </button>
                        <button class="btn btn-link btn-favorite p-0" 
                                onclick="eliminarDeFavoritos('${producto._id}', '${producto.nombre.replace(/'/g, "\\'")}')"
                                title="Eliminar de favoritos">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        favoritesContainer.appendChild(col);
        console.log("Producto renderizado:", producto.nombre);
    });
    
    console.log("Todos los favoritos han sido renderizados");
}

// Obtener clase de badge seg√∫n estado
function obtenerClaseBadge(estado) {
    switch(estado) {
        case "Disponible":
            return "bg-success";
        case "Agotado":
            return "bg-danger";
        case "Descontinuado":
            return "bg-warning text-dark";
        default:
            return "bg-secondary";
    }
}

// Eliminar de favoritos
async function eliminarDeFavoritos(id, nombre) {
    if (!confirm(`¬øEliminar "${nombre}" de tus favoritos?`)) {
        return;
    }

    try {
        const usuarioEmail = obtenerUsuarioEmail();
        const url = usuarioEmail 
            ? `http://127.0.0.1:8000/favoritos/${id}?usuario_email=${encodeURIComponent(usuarioEmail)}`
            : `http://127.0.0.1:8000/favoritos/${id}`;
        
        const response = await fetch(url, {
            method: "DELETE"
        });

        if (response.ok) {
            console.log(`"${nombre}" eliminado de favoritos`);
            await cargarFavoritos(); // Recargar la lista
        } else {
            alert("Error al eliminar de favoritos ‚ùå");
        }
    } catch (error) {
        console.error("Error:", error);
        alert("Error al eliminar de favoritos");
    }
}

// Agregar al carrito desde favoritos
async function agregarAlCarritoDesdeFavoritos(id, nombre, precio, imagen) {
    try {
        const usuarioEmail = obtenerUsuarioEmail();
        if (!usuarioEmail) {
            alert("Por favor, inicia sesi√≥n para agregar productos al carrito");
            return;
        }
        
        // Verificar si ya est√° en el carrito
        const yaEnCarrito = carritoGlobal.some(c => c.nombre === nombre);
        if (yaEnCarrito) {
            alert("Este producto ya est√° en tu carrito üõí");
            return;
        }

        const response = await fetch("http://127.0.0.1:8000/carrito", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                nombre, 
                precio, 
                imagen,
                cantidad: 1,
                usuario_email: usuarioEmail
            })
        });

        if (response.ok) {
            await inicializarCarrito(); // Actualizar carrito
            await cargarFavoritos(); // Re-renderizar para actualizar botones
            console.log(`"${nombre}" agregado al carrito`);
        } else {
            alert("No se pudo agregar al carrito ‚ùå");
        }
    } catch (error) {
        console.error("Error:", error);
        alert("Error al agregar al carrito");
    }
}

// Inicializaci√≥n
// --- Funci√≥n para mostrar/ocultar enlaces del navbar seg√∫n sesi√≥n ---
function actualizarEnlacesNavbar() {
    let usuarioEmail = localStorage.getItem("usuarioEmail");
    
    if (!usuarioEmail) {
        const usuarioLocal = localStorage.getItem("usuario");
        if (usuarioLocal) {
            try {
                const usuarioObj = JSON.parse(usuarioLocal);
                if (usuarioObj && typeof usuarioObj === 'object' && usuarioObj.correo) {
                    usuarioEmail = usuarioObj.correo;
                    localStorage.setItem("usuarioEmail", usuarioEmail);
                }
            } catch (e) {
                if (usuarioLocal.includes("@")) {
                    usuarioEmail = usuarioLocal;
                    localStorage.setItem("usuarioEmail", usuarioEmail);
                }
            }
        }
    }
    
    // Detectar super usuario por objeto usuario o email
    let esSuperUser = false;
    const uLocal = localStorage.getItem("usuario");
    if (uLocal) {
        try { const uObj = JSON.parse(uLocal); if (uObj && uObj.es_super_usuario === true) esSuperUser = true; } catch(e) {}
    }
    if (!esSuperUser && usuarioEmail) {
        esSuperUser = usuarioEmail.toLowerCase() === "rafaarodriguezjr@gmail.com";
    }

    // Portal de empleados: visible solo super usuario
    const portalEmpleados = document.getElementById("nav-portal-empleados");
    if (portalEmpleados) portalEmpleados.style.display = esSuperUser ? "" : "none";

    // Historial de pedidos: visible si hay sesi√≥n (o super)
    const historialPedidos = document.getElementById("nav-historial-pedidos");
    if (historialPedidos) historialPedidos.style.display = (usuarioEmail || esSuperUser) ? "" : "none";
    
    // Ocultar enlaces de registro e inicio sesi√≥n si hay sesi√≥n iniciada
    const inicioSesion = document.getElementById("nav-inicio-sesion");
    const registro = document.getElementById("nav-registro");
    
    if (usuarioEmail) {
        // Si hay sesi√≥n, ocultar registro e inicio sesi√≥n
        if (inicioSesion) inicioSesion.style.display = "none";
        if (registro) registro.style.display = "none";
    } else {
        // Si no hay sesi√≥n, mostrar registro e inicio sesi√≥n
        if (inicioSesion) inicioSesion.style.display = "";
        if (registro) registro.style.display = "";
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    // Actualizar visibilidad de enlaces del navbar seg√∫n sesi√≥n
    actualizarEnlacesNavbar();
    console.log("Iniciando p√°gina de favoritos...");
    
    await inicializarCarrito();
    await cargarFavoritos();
    
    console.log("P√°gina de favoritos cargada");
});
</script>
<script src="js/carrito-global.js"></script>
</body>
</html>